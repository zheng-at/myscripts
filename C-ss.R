install.packages("ggplot2")
install.packages("PKNCA")
install.packages("dplyr")

library(ggplot2)
library(PKNCA)
library(dplyr)

install.packages("RColorBrewer")
library(RColorBrewer)
install.packages("ggalt")
library(ggalt)
(.packages())

colors()

start_a<-colors()[grep('^a',colors())]
start_b<-colors()[grep('^b',colors())]
start_c<-colors()[grep('^c',colors())]
start_d<-colors()[grep('^d',colors())]
start_f<-colors()[grep('^f',colors())]
start_g<-colors()[grep('^g',colors())]
start_h<-colors()[grep('^h',colors())]
start_i<-colors()[grep('^i',colors())]
start_k<-colors()[grep('^k',colors())]
start_l<-colors()[grep('^l',colors())]
start_m<-colors()[grep('^m',colors())]
start_n<-colors()[grep('^n',colors())]
start_o<-colors()[grep('^o',colors())]
start_p<-colors()[grep('^p',colors())]
start_r<-colors()[grep('^r',colors())]
start_s<-colors()[grep('^s',colors())]
start_t<-colors()[grep('^t',colors())]
start_v<-colors()[grep('^v',colors())]
start_w<-colors()[grep('^w',colors())]

start_a[(length(start_a)+1):222]<-'.'
start_b[(length(start_b)+1):222]<-'.'
start_c[(length(start_c)+1):222]<-'.'
start_d[(length(start_d)+1):222]<-'.'
start_f[(length(start_f)+1):222]<-'.'
start_h[(length(start_h)+1):222]<-'.'
start_i[(length(start_i)+1):222]<-'.'
start_k[(length(start_k)+1):222]<-'.'
start_l[(length(start_l)+1):222]<-'.'
start_m[(length(start_m)+1):222]<-'.'
start_n[(length(start_n)+1):222]<-'.'
start_o[(length(start_o)+1):222]<-'.'
start_p[(length(start_p)+1):222]<-'.'
start_r[(length(start_r)+1):222]<-'.'
start_s[(length(start_s)+1):222]<-'.'
start_t[(length(start_t)+1):222]<-'.'
start_v[(length(start_v)+1):222]<-'.'
start_w[(length(start_w)+1):222]<-'.'

colors_stratum<-data.frame(
  start_a,start_b,start_c,start_d,
  start_f,start_g,start_h,start_i,start_k,
  start_l,start_m,start_n,start_o,start_p,
  start_r,start_s,start_t,start_v,start_w)

View(colors_stratum)

###

subject<-c(
rep(1,16),rep(2,16),rep(3,16),rep(4,16),rep(5,16),rep(6,16),
rep(7,16),rep(8,16),rep(9,16),rep(10,16),rep(11,16),rep(12,16),
rep(13,16),rep(14,16),rep(15,16),rep(16,16),rep(17,16),rep(18,16),
rep(19,16),rep(20,16),rep(21,16),rep(22,16),rep(23,16),rep(24,16))

dose<-rep(10,16*24)

time<-rep(c(0,0.5,1,1.5,2,3,4,5,6,8,10,12,24,36,48,72),24)

conc1<-c(0,14,61.4,179,280,257,220,238,214,168,131,97,24.2,6.95,3.68,0.84)
conc2<-c(0,74,402,456,412,333,285,223,195,134,110,74.7,22.2,7.58,3.47,0.937)
conc3<-c(0,3.69,58.7,402,615,403,360,316,255,176,130,102,30.5,12.6,8,1.87)
conc4<-c(0,25.6,109,262,414,397,297,246,208,153,117,81.1,29,8.37,3.69,1.07)
conc5<-c(0,12.7,26.2,55.8,186,306,236,195,155,117,88.3,60.5,18.7,5.97,2.6,0.587)
conc6<-c(0,241,325,367,338,269,208,182,150,113,85.8,71.5,23.7,9.09,5.82,2.25)
conc7<-c(0,749,726,552,394,291,248,183,139,90.6,65.8,45.5,16.8,5.24,2.15,0.593)
conc8<-c(0,116,264,349,343,314,267,235,204,146,108,70.3,20.3,8.54,3.98,1.63)
conc9<-c(0,35.1,69.9,143,167,197,183,202,168,136,107,80.4,28.8,11.3,5.34,1.84)
conc10<-c(0,44.4,210,304,320,228,161,141,119,84.6,70.6,57.9,22,6.23,3.16,0.758)
conc11<-c(0,265,357,411,392,252,199,174,140,115,81.1,62.6,26.5,9.08,3.9,1.29)
conc12<-c(0,323,379,392,376,270,203,180,156,117,89.2,76.8,29.3,14.2,6.39,2.31)
conc13<-c(0,0,0.717,3.91,22.5,128,284,244,174,141,117,100,37.1,15.8,7.87,2.24)
conc14<-c(0,8.4,159,339,289,229,203,165,140,110,93.2,67,23.5,7.85,4.13,0.92)
conc15<-c(0,16.2,66,381,492,304,228,188,150,114,87.5,62.6,16.3,4.65,1.98,0)
conc16<-c(0,245,740,684,569,387,289,254,195,149,99.4,78.1,21.5,7.39,3.66,0.916)
conc17<-c(0,169,401,506,440,294,217,182,153,119,98.1,78.5,31.5,13.6,6.84,1.88)
conc18<-c(0,63.2,196,275,318,255,213,218,187,141,105,81.8,26.9,10,5.68,1.25)
conc19<-c(0,301,486,453,405,302,221,194,168,120,107,89.7,35,10.1,5.99,1.47)
conc20<-c(0,213,451,361,311,273,222,186,158,113,90.2,69.8,28.2,9.22,5.04,1.5)
conc21<-c(0,150,388,434,462,320,268,210,175,125,94.9,71.9,21.8,9.22,5.17,1.41)
conc22<-c(0,6.95,111,453,401,250,211,194,164,117,90.7,64.7,24.7,11,6.29,1.93)
conc23<-c(0,50.8,266,337,333,260,231,212,175,131,103,78.8,31.5,11.7,6.76,2.07)
conc24<-c(0,54,106,209,275,258,280,256,215,161,117,93.7,20.3,5.6,2.15,0.691)

concentration<-c(
conc1,conc2,conc3,conc4,conc5,conc6,conc7,conc8,
conc9,conc10,conc11,conc12,conc13,conc14,conc15,conc16,
conc17,conc18,conc19,conc20,conc21,conc22,conc23,conc24)

time_concentration<-data.frame(subject,dose,time,concentration)

View(time_concentration)

curve<-function(a,b){
  ggplot(data=time_concentration[a:b,],aes(x=time,y=concentration))+
  geom_line(color='royalblue')+
  geom_point(color='red3')+
  facet_wrap(~subject,ncol=4)}

shell('cls')

#subject1(1,16),subject9(129,144),subject18(273,288),subject24(369,384)
#subject12(177,192)
#d_conc<-as.data.frame(datasets::Theoph)%>%mutate(Subject=as.numeric(as.character(Subject)))
#d_dose<-d_conc[d_conc$Time==0,]
#d_dose$Time<-0
#conc_obj<-PKNCAconc(d_conc,conc~Time|Subject)
#dose_obj<-PKNCAdose(d_dose,Dose~Time|Subject)
#data_obj<-PKNCAdata(conc_obj,dose_obj)
#results_obj<-pk.nca(data_obj)
#summary(results_obj)

d_dose<-time_concentration[time_concentration$time==0,]
conc_obj<-PKNCAconc(time_concentration,concentration~time|subject)
dose_obj<-PKNCAdose(d_dose,dose~time|subject)
data_obj<-PKNCAdata(conc_obj,dose_obj)
results_obj<-pk.nca(data_obj)
summary(results_obj)

#subject15(225,240)
index.half.life<-which(results_obj$result$PPTESTCD=='half.life')
all.half.life<-results_obj$result[index.half.life,]$PPORRES
mod.half.life<-all.half.life[-15]
mean(mod.half.life)

index.cmax<-which(results_obj$result$PPTESTCD=='cmax')
all.cmax<-results_obj$result[index.cmax,]$PPORRES
mod.cmax<-all.cmax[-15]
exp(mean(log(mod.cmax)))

d1<-76.8
u1<-76.8*0.94+398
d2<-76.8*0.5*0.94+398*0.5
u2<-76.8*0.5*0.94^2+398*0.5*0.94+398
d3<-76.8*0.5^2*0.94^2+398*0.5^2*0.94+398*0.5
u3<-76.8*0.5^2*0.94^3+398*0.5^2*0.94^2+398*0.5*0.94+398
d4<-76.8*0.5^3*0.94^3+398*0.5^3*0.94^2+398*0.5^2*0.94+398*0.5
u4<-76.8*0.5^3*0.94^4+398*0.5^3*0.94^3+398*0.5^2*0.94^2+398*0.5*0.94+398
d5<-76.8*0.5^4*0.94^4+398*0.5^4*0.94^3+398*0.5^3*0.94^2+398*0.5^2*0.94+398*0.5
u5<-76.8*0.5^4*0.94^5+398*0.5^4*0.94^4+398*0.5^3*0.94^3+398*0.5^2*0.94^2+398*0.5*0.94+398
d6<-76.8*0.5^5*0.94^5+398*0.5^5*0.94^4+398*0.5^4*0.94^3+398*0.5^3*0.94^2+398*0.5^2*0.94+398*0.5
u6<-76.8*0.5^5*0.94^6+398*0.5^5*0.94^5+398*0.5^4*0.94^4+398*0.5^3*0.94^3+398*0.5^2*0.94^2+398*0.5*0.94+398
d7<-76.8*0.5^6*0.94^6+398*0.5^6*0.94^5+398*0.5^5*0.94^4+398*0.5^4*0.94^3+398*0.5^3*0.94^2+398*0.5^2*0.94+398*0.5
u7<-76.8*0.5^6*0.94^7+398*0.5^6*0.94^6+398*0.5^5*0.94^5+398*0.5^4*0.94^4+398*0.5^3*0.94^3+398*0.5^2*0.94^2+398*0.5*0.94+398
d8<-76.8*0.5^7*0.94^7+398*0.5^7*0.94^6+398*0.5^6*0.94^5+398*0.5^5*0.94^4+398*0.5^4*0.94^3+398*0.5^3*0.94^2+398*0.5^2*0.94+398*0.5

Css.c.bid<-c(d1,u1,d2,u2,d3,u3,d4,u4,d5,u5,d6,u6,d7,u7,d8)
Css.t.bid<-c(12.6,
         1.5+12.6,
         1.5+12.6*2,
         1.5*2+12.6*2,
         1.5*2+12.6*3,
         1.5*3+12.6*3,
         1.5*3+12.6*4,
         1.5*4+12.6*4,
         1.5*4+12.6*5,
         1.5*5+12.6*5,
         1.5*5+12.6*6,
         1.5*6+12.6*6,
         1.5*6+12.6*7,
         1.5*7+12.6*7,
         1.5*7+12.6*8)


D1<-156
U1<-156*0.94+398
D2<-156*0.75*0.94+398*0.75
U2<-156*0.75*0.94^2+398*0.75*0.94+398
D3<-156*0.75^2*0.94^2+398*0.75^2*0.94+398*0.75
U3<-156*0.75^2*0.94^3+398*0.75^2*0.94^2+398*0.75*0.94+398
D4<-156*0.75^3*0.94^3+398*0.75^3*0.94^2+398*0.75^2*0.94+398*0.75
U4<-156*0.75^3*0.94^4+398*0.75^3*0.94^3+398*0.75^2*0.94^2+398*0.75*0.94+398
D5<-156*0.75^4*0.94^4+398*0.75^4*0.94^3+398*0.75^3*0.94^2+398*0.75^2*0.94+398*0.75
U5<-156*0.75^4*0.94^5+398*0.75^4*0.94^4+398*0.75^3*0.94^3+398*0.75^2*0.94^2+398*0.75*0.94+398
D6<-156*0.75^5*0.94^5+398*0.75^5*0.94^4+398*0.75^4*0.94^3+398*0.75^3*0.94^2+398*0.75^2*0.94+398*0.75
U6<-156*0.75^5*0.94^6+398*0.75^5*0.94^5+398*0.75^4*0.94^4+398*0.75^3*0.94^3+398*0.75^2*0.94^2+398*0.75*0.94+398
D7<-156*0.75^6*0.94^6+398*0.75^6*0.94^5+398*0.75^5*0.94^4+398*0.75^4*0.94^3+398*0.75^3*0.94^2+398*0.75^2*0.94+398*0.75
U7<-156*0.75^6*0.94^7+398*0.75^6*0.94^6+398*0.75^5*0.94^5+398*0.75^4*0.94^4+398*0.75^3*0.94^3+398*0.75^2*0.94^2+398*0.75*0.94+398
D8<-156*0.75^7*0.94^7+398*0.75^7*0.94^6+398*0.75^6*0.94^5+398*0.75^5*0.94^4+398*0.75^4*0.94^3+398*0.75^3*0.94^2+398*0.75^2*0.94+398*0.75
U8<-156*0.75^7*0.94^8+398*0.75^7*0.94^7+398*0.75^6*0.94^6+398*0.75^5*0.94^5+398*0.75^4*0.94^4+398*0.75^3*0.94^3+398*0.75^2*0.94^2+398*0.75*0.94+398
D9<-156*0.75^8*0.94^8+398*0.75^8*0.94^7+398*0.75^7*0.94^6+398*0.75^6*0.94^5+398*0.75^5*0.94^4+398*0.75^4*0.94^3+398*0.75^3*0.94^2+398*0.75^2*0.94+398*0.75
U9<-156*0.75^8*0.94^9+398*0.75^8*0.94^8+398*0.75^7*0.94^7+398*0.75^6*0.94^6+398*0.75^5*0.94^5+398*0.75^4*0.94^4+398*0.75^3*0.94^3+398*0.75^2*0.94^2+398*0.75*0.94+398
D10<-156*0.75^9*0.94^9+398*0.75^9*0.94^8+398*0.75^8*0.94^7+398*0.75^7*0.94^6+398*0.75^6*0.94^5+398*0.75^5*0.94^4+398*0.75^4*0.94^3+398*0.75^3*0.94^2+398*0.75^2*0.94+398*0.75
U10<-156*0.75^10*0.94^9+398*0.75^9*0.94^9+398*0.75^8*0.94^8+398*0.75^7*0.94^7+398*0.75^6*0.94^6+398*0.75^5*0.94^5+398*0.75^4*0.94^4+398*0.75^3*0.94^3+398*0.75^2*0.94^2+398*0.75*0.94+398
D11<-156*0.75^11*0.94^9+398*0.75^10*0.94^9+398*0.75^9*0.94^8+398*0.75^8*0.94^7+398*0.75^7*0.94^6+398*0.75^6*0.94^5+398*0.75^5*0.94^4+398*0.75^4*0.94^3+398*0.75^3*0.94^2+398*0.75^2*0.94+398*0.75

Css.c.tid<-c(D1,U1,D2,U2,D3,U3,D4,U4,D5,U5,D6,U6,D7,U7,D8,U8,D9,U9,D10,U10,D11)

Css.t.tid<-c(6.3,
             1.5+6.3,
             1.5+6.3*2,
             1.5*2+6.3*2,
             1.5*2+6.3*3,
             1.5*3+6.3*3,
             1.5*3+6.3*4,
             1.5*4+6.3*4,
             1.5*4+6.3*5,
             1.5*5+6.3*5,
             1.5*5+6.3*6,
             1.5*6+6.3*6,
             1.5*6+6.3*7,
             1.5*7+6.3*7,
             1.5*7+6.3*8,
             1.5*8+6.3*8,
             1.5*8+6.3*9,
             1.5*9+6.3*9,
             1.5*9+6.3*10,
             1.5*10+6.3*10,
             1.5*10+6.3*11)

mode<-c(rep('qd',16),rep('bid',15),rep('tid',21))

time<-c(0,0.5,1,1.5,2,3,4,5,6,8,10,12,24,36,48,72,
        12.6,14.1,26.7,28.2,40.8,42.3,54.9,56.4,69,
        70.5,83.1,84.6,97.2,98.7,111.3,
        6.3,7.8,14.1,15.6,21.9,23.4,29.7,31.2,37.5,39,45.3,46.8,53.1,54.6,
        60.9,62.4,68.7,70.2,76.5,78,84.3)

conc<-c(0,323,379,392,376,270,203,180,156,117,89.2,76.8,29.3,14.2,6.39,2.31,
        76.8,470.19,235.1,618.99,309.5,688.93,344.46,721.79,360.9,737.24,
        368.62,744.5,372.25,747.92,373.96,
        156,544.64,408.48,781.97,586.48,949.29,711.97,1067.25,800.44,1150.41,
        862.81,1209.04,906.78,1250.37,937.78,1279.51,959.63,1300.06,975.04,
        1313.26,984.95)
sad_mad<-data.frame(mode,time,conc)

ggplot(data=sad_mad,aes(x=time,y=conc,color=mode))+
  geom_line()+
  geom_point()+
  geom_text(aes(x=time[4],y=conc[4],label='398ng/mL'),vjust=-.75,size=4,color='black',family='serif')+
  geom_text(aes(x=time[17],y=conc[17],label='76.8ng/mL'),vjust=1.7,size=4,color='black',family='serif')+
  geom_text(aes(x=time[30],y=conc[30],label='747.92ng/mL'),vjust=-.55,size=4,color='black',family='serif')+
  geom_text(aes(x=time[31],y=conc[31],label='373.96ng/mL'),vjust=1.25,size=4,color='black',family='serif')+
  geom_text(aes(x=time[32],y=conc[32],label='156ng/mL'),vjust=1.25,size=4,color='black',family='serif')+
  geom_text(aes(x=time[51],y=conc[51],label='1313.26ng/mL'),vjust=-.55,size=4,color='black',family='serif')+
  geom_text(aes(x=time[52],y=conc[52],label='984.95ng/mL'),vjust=1.25,size=4,color='black',family='serif')


install.packages("UBCRM")

library(UBCRM)

# a 6-dose study with 5% 11% 19% 23% 30% 45% of true rates of toxicity

# sim3p3(c(0.05,0.11,0.19,0.23,0.3,0.45),seed=1)

ssim3p3(c(0.05,0.11,0.19,0.23,0.3,0.45),n=1000,seed=10)

## BOIN

install.packages("BOIN")

library(BOIN)

get.boundary(target=0.3,ncohort=6,cohortsize=3)

oc<-get.oc(target=0.3,p.true=c(0.05,0.11,0.19,0.23,0.3,0.45),ncohort=16,cohortsize=3,ntrial=1000)
summary(oc)
